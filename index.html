<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èŠ±ç«ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.card-container {
  display: flex;
  flex-wrap: nowrap;
  gap: 6px;
}

.card-item {
  flex: 1 1 0;
  min-width: 0;
  padding: 6px;
  border: 2px solid #ccc;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
  font-size: 0.75rem;
}

.card-item.selected {
  border-color: #0d6efd;
  background-color: #e7f1ff;
}

.candidate {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin: 1px;
  border: 1px solid #000;
}

.candidate-number {
  display: inline-block;
  width: 16px;
  height: 16px;
  line-height: 16px;
  border-radius: 50%;
  border: 1px solid #000;
  margin: 1px;
  font-size: 0.7rem;
}

.flex-single {
  display: flex;
  flex-wrap: nowrap;
  gap: 4px;
}

.flex-single .btn {
  flex: 1 1 0;
  padding: 6px 0;
  font-size: 0.75rem;
  white-space: nowrap;
}

.btn-toggle.active {
  box-shadow: inset 0 0 4px #000;
}

.btn-light-add {
  background-color: #cce5ff;
  border: 1px solid #99c2ff;
}

.btn-light-undo {
  background-color: #ffe5cc;
  border: 1px solid #ffb380;
}
</style>
</head>

<body>
<div class="container mt-3">

<h5 class="text-center mb-2">èŠ±ç«ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</h5>

<details class="mb-3">
  <summary class="small">ğŸ“– ä½¿ã„æ–¹ï¼ˆ30ç§’ï¼‰</summary>
  <ol class="small mt-2">
    <li>ã‚«ãƒ¼ãƒ‰ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ã—ã¦å¯¾è±¡é¸æŠ</li>
    <li>è‰² or æ•°å­—ã‚’1ã¤é¸æŠ</li>
    <li>ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ </li>
  </ol>
</details>

<div id="settings">
  <div class="mb-2 small">æ‰‹æœ­æšæ•°</div>
  <div id="handSizeButtons" class="mb-2">
    <button class="btn btn-outline-primary btn-toggle" data-value="4">4</button>
    <button class="btn btn-outline-primary btn-toggle" data-value="5">5</button>
  </div>

  <div class="mb-2 small">è‰²æ•°</div>
  <div id="colorCountButtons" class="mb-3">
    <button class="btn btn-outline-secondary btn-toggle" data-value="5">5</button>
    <button class="btn btn-outline-secondary btn-toggle" data-value="6">6</button>
  </div>

  <button class="btn btn-success w-100" id="startGameBtn">é–‹å§‹</button>

  <div class="mt-3 text-center">
    <div id="qrCode"></div>
  </div>
</div>

<div id="game" style="display:none;">
  <div class="card-container mb-2" id="handContainer"></div>

  <div class="mb-1 small">è‰²ãƒ’ãƒ³ãƒˆ</div>
  <div id="colorButtons" class="flex-single mb-2"></div>

  <div class="mb-1 small">æ•°å­—ãƒ’ãƒ³ãƒˆ</div>
  <div id="numberButtons" class="flex-single mb-2"></div>

  <button class="btn btn-light-add w-100 mb-2" id="addHintBtn">ãƒ’ãƒ³ãƒˆè¿½åŠ </button>
  <button class="btn btn-light-undo w-100 mb-2" id="undoBtn">Undo</button>

  <ul class="list-group small" id="hintHistory"></ul>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
let handSize=5,colorCount=6;
let colors=[],numbers=["1","2","3","4","5"];
let handCandidates=[],history=[],selectedCards=new Set();
const baseColors=["red","blue","green","yellow","white","purple"];

const lightenColor=c=>({
  red:"#ff9999",blue:"#99ccff",green:"#99ff99",
  yellow:"#ffff99",white:"#f2f2f2",purple:"#cc99ff"
}[c]);

const setupToggle=id=>{
  document.querySelectorAll(`#${id} .btn-toggle`).forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(`#${id} .btn-toggle`).forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
  });
};
setupToggle("handSizeButtons");
setupToggle("colorCountButtons");

new QRCode(qrCode,{text:"https://takahirosakuda.github.io/hanabi-memo/",width:128,height:128});

startGameBtn.onclick=()=>{
  const h=document.querySelector("#handSizeButtons .active");
  const c=document.querySelector("#colorCountButtons .active");
  if(!h||!c) return;
  handSize=+h.dataset.value;
  colorCount=+c.dataset.value;
  colors=baseColors.slice(0,colorCount);
  initGame();
  settings.style.display="none";
  game.style.display="block";
};

function initGame(){
  handCandidates=Array(handSize).fill().map(()=>({colors:[...colors],numbers:[...numbers]}));
  history=[];
  hintHistory.innerHTML="";
  selectedCards.clear();
  renderHand();
  initHintButtons();
}

function renderHand(){
  handContainer.innerHTML="";
  handCandidates.forEach((_,i)=>{
    const d=document.createElement("div");
    d.className="card-item";
    d.innerHTML=`<div>ã‚«ãƒ¼ãƒ‰${i+1}</div><div id="c${i}"></div>`;
    d.onclick=()=>{
      d.classList.toggle("selected");
      d.classList.contains("selected")?selectedCards.add(i):selectedCards.delete(i);
    };
    handContainer.appendChild(d);
  });
  renderCandidates();
}

function renderCandidates(){
  handCandidates.forEach((c,i)=>{
    const d=document.getElementById(`c${i}`);
    d.innerHTML="";
    c.colors.forEach(x=>{
      const s=document.createElement("span");
      s.className="candidate";
      s.style.background=lightenColor(x);
      d.appendChild(s);
    });
    d.appendChild(document.createElement("br"));
    c.numbers.forEach(n=>{
      const s=document.createElement("span");
      s.className="candidate-number";
      s.textContent=n;
      d.appendChild(s);
    });
  });
}

function initHintButtons(){
  colorButtons.innerHTML="";
  numberButtons.innerHTML="";
  colors.forEach(c=>{
    const b=document.createElement("button");
    b.className="btn btn-toggle";
    b.style.background=lightenColor(c);
    b.textContent=c;
    b.onclick=()=>{
      document.querySelectorAll("#numberButtons .active").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll("#colorButtons .btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
    colorButtons.appendChild(b);
  });
  numbers.forEach(n=>{
    const b=document.createElement("button");
    b.className="btn btn-toggle btn-outline-secondary";
    b.textContent=n;
    b.onclick=()=>{
      document.querySelectorAll("#colorButtons .active").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll("#numberButtons .btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
    numberButtons.appendChild(b);
  });
}

addHintBtn.onclick=()=>{
  const c=document.querySelector("#colorButtons .active");
  const n=document.querySelector("#numberButtons .active");
  if(!c&&!n) return;
  history.push(JSON.parse(JSON.stringify(handCandidates)));
  handCandidates.forEach((x,i)=>{
    if(selectedCards.has(i)){
      if(c) x.colors=[c.textContent];
      if(n) x.numbers=[n.textContent];
    }else{
      if(c) x.colors=x.colors.filter(v=>v!==c.textContent);
      if(n) x.numbers=x.numbers.filter(v=>v!==n.textContent);
    }
  });
  const li=document.createElement("li");
  li.className="list-group-item";
  li.textContent=(c?"è‰²:":"æ•°å­—:")+(c?.textContent||n.textContent);
  hintHistory.prepend(li);
  document.querySelectorAll(".active").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".card-item").forEach(c=>c.classList.remove("selected"));
  selectedCards.clear();
  renderCandidates();
};

undoBtn.onclick=()=>{
  if(!history.length) return;
  handCandidates=history.pop();
  hintHistory.firstChild?.remove();
  renderCandidates();
};
</script>
</body>
</html>
