<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èŠ±ç«ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.card-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.card-item {
  flex: 1 1 18%;
  min-width: 80px;
  padding: 10px;
  border: 2px solid #ccc;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
}

.card-item.selected {
  border-color: #0d6efd;
  background-color: #e7f1ff;
}

.candidate {
  display: inline-block;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  margin: 2px;
  border: 1px solid #000;
}

.candidate-number {
  display: inline-block;
  width: 18px;
  height: 18px;
  line-height: 18px;
  border-radius: 50%;
  border: 1px solid #000;
  margin: 2px;
  font-size: 0.8rem;
}

.flex-single {
  display: flex;
  gap: 5px;
}

.flex-single .btn {
  flex: 1 1 0;
}

.btn-toggle.active {
  box-shadow: inset 0 0 4px #000;
}

.btn-light-add {
  background-color: #cce5ff;
  border: 1px solid #99c2ff;
}

.btn-light-undo {
  background-color: #ffe5cc;
  border: 1px solid #ffb380;
}
</style>
</head>

<body>
<div class="container mt-4">

<h1 class="text-center mb-3">èŠ±ç«ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª</h1>

<!-- ä½¿ã„æ–¹ -->
<details class="mb-4">
  <summary class="h6">ğŸ“– ä½¿ã„æ–¹ï¼ˆ30ç§’ã§èª­ã‚ã‚‹ï¼‰</summary>
  <div class="small mt-2">
    <ol>
      <li>æ‰‹æœ­æšæ•°ãƒ»è‰²æ•°ã‚’é¸ã‚“ã§é–‹å§‹</li>
      <li><strong>ãƒ’ãƒ³ãƒˆå¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—</strong></li>
      <li>è‰² or æ•°å­—ã‚’1ã¤é¸ã‚“ã§ã€Œãƒ’ãƒ³ãƒˆã‚’è¿½åŠ ã€</li>
      <li>ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸï¼æ¨ã¦ãŸã‚‰ã€Œãƒ—ãƒ¬ã‚¤ã€</li>
    </ol>
  </div>
</details>

<!-- è¨­å®š -->
<div id="settings">
  <div class="mb-2">æ‰‹æœ­æšæ•°</div>
  <div id="handSizeButtons" class="mb-3">
    <button class="btn btn-outline-primary btn-toggle" data-value="4">4æš</button>
    <button class="btn btn-outline-primary btn-toggle" data-value="5">5æš</button>
  </div>

  <div class="mb-2">è‰²ã®æ•°</div>
  <div id="colorCountButtons" class="mb-3">
    <button class="btn btn-outline-secondary btn-toggle" data-value="5">5è‰²</button>
    <button class="btn btn-outline-secondary btn-toggle" data-value="6">6è‰²</button>
  </div>

  <button class="btn btn-success w-100" id="startGameBtn">é–‹å§‹</button>

  <!-- QRã‚³ãƒ¼ãƒ‰ -->
  <div class="mt-4 text-center">
    <div class="small text-muted mb-1">ğŸ“± å…±æœ‰ç”¨QRã‚³ãƒ¼ãƒ‰</div>
    <div id="qrCode"></div>
  </div>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div id="game" style="display:none;">
  <h5>æ‰‹æœ­ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦å¯¾è±¡é¸æŠï¼‰</h5>
  <div class="card-container mb-3" id="handContainer"></div>

  <h5>ãƒ’ãƒ³ãƒˆå…¥åŠ›</h5>

  <div class="mb-2">
    <div>è‰²ãƒ’ãƒ³ãƒˆï¼ˆæŠä¸€ï¼‰</div>
    <div id="colorButtons" class="flex-single"></div>
  </div>

  <div class="mb-2">
    <div>æ•°å­—ãƒ’ãƒ³ãƒˆï¼ˆæŠä¸€ï¼‰</div>
    <div id="numberButtons" class="flex-single"></div>
  </div>

  <button class="btn btn-light-add w-100 mb-2" id="addHintBtn">ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ </button>
  <button class="btn btn-light-undo w-100 mb-3" id="undoBtn">Undo</button>

  <h5>ãƒ’ãƒ³ãƒˆå±¥æ­´</h5>
  <ul class="list-group" id="hintHistory"></ul>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
let handSize = 5;
let colorCount = 6;
let colors = [];
let numbers = ["1","2","3","4","5"];
let handCandidates = [];
let history = [];
let selectedCards = new Set();

const baseColors = ["red","blue","green","yellow","white","purple"];

function lightenColor(c){
  return {
    red:"#ff9999", blue:"#99ccff", green:"#99ff99",
    yellow:"#ffff99", white:"#f2f2f2", purple:"#cc99ff"
  }[c];
}

function setupToggle(id){
  document.querySelectorAll(`#${id} .btn-toggle`).forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(`#${id} .btn-toggle`).forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
  });
}

setupToggle("handSizeButtons");
setupToggle("colorCountButtons");

new QRCode(document.getElementById("qrCode"), {
  text: "https://takahirosakuda.github.io/hanabi-memo/",
  width: 128,
  height: 128
});

startGameBtn.onclick=()=>{
  const h=document.querySelector("#handSizeButtons .active");
  const c=document.querySelector("#colorCountButtons .active");
  if(!h||!c) return alert("é¸æŠã—ã¦ãã ã•ã„");

  handSize=+h.dataset.value;
  colorCount=+c.dataset.value;
  colors=baseColors.slice(0,colorCount);

  initGame();
  settings.style.display="none";
  game.style.display="block";
};

function initGame(){
  handCandidates=Array(handSize).fill().map(()=>({
    colors:[...colors], numbers:[...numbers]
  }));
  history=[];
  hintHistory.innerHTML="";
  selectedCards.clear();
  renderHand();
  initHintButtons();
}

function renderHand(){
  handContainer.innerHTML="";
  handCandidates.forEach((_,i)=>{
    const d=document.createElement("div");
    d.className="card-item";
    d.innerHTML=`
      <div>ã‚«ãƒ¼ãƒ‰${i+1}</div>
      <div id="candidates${i}"></div>
      <button class="btn btn-sm btn-outline-success mt-2">ãƒ—ãƒ¬ã‚¤</button>
    `;

    d.onclick=()=>{
      d.classList.toggle("selected");
      d.classList.contains("selected")
        ? selectedCards.add(i)
        : selectedCards.delete(i);
    };

    d.querySelector("button").onclick=(e)=>{
      e.stopPropagation();
      handCandidates[i]={colors:[...colors],numbers:[...numbers]};
      d.classList.remove("selected");
      selectedCards.delete(i);
      renderCandidates();
    };

    handContainer.appendChild(d);
  });
  renderCandidates();
}

function renderCandidates(){
  handCandidates.forEach((c,i)=>{
    const d=document.getElementById(`candidates${i}`);
    d.innerHTML="";
    c.colors.forEach(x=>{
      const s=document.createElement("span");
      s.className="candidate";
      s.style.background=lightenColor(x);
      d.appendChild(s);
    });
    d.appendChild(document.createElement("br"));
    c.numbers.forEach(n=>{
      const s=document.createElement("span");
      s.className="candidate-number";
      s.textContent=n;
      d.appendChild(s);
    });
  });
}

function initHintButtons(){
  colorButtons.innerHTML="";
  numberButtons.innerHTML="";

  colors.forEach(c=>{
    const b=document.createElement("button");
    b.className="btn btn-toggle";
    b.textContent=c;
    b.style.background=lightenColor(c);
    b.onclick=()=>{
      document.querySelectorAll("#numberButtons .active").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll("#colorButtons .btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
    colorButtons.appendChild(b);
  });

  numbers.forEach(n=>{
    const b=document.createElement("button");
    b.className="btn btn-toggle btn-outline-secondary";
    b.textContent=n;
    b.onclick=()=>{
      document.querySelectorAll("#colorButtons .active").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll("#numberButtons .btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
    numberButtons.appendChild(b);
  });
}

addHintBtn.onclick=()=>{
  const colorBtn=document.querySelector("#colorButtons .active");
  const numBtn=document.querySelector("#numberButtons .active");
  if(!colorBtn && !numBtn) return;

  history.push(JSON.parse(JSON.stringify(handCandidates)));

  handCandidates.forEach((c,i)=>{
    if(selectedCards.size && !selectedCards.has(i)){
      if(colorBtn) c.colors=c.colors.filter(x=>x!==colorBtn.textContent);
      if(numBtn) c.numbers=c.numbers.filter(x=>x!==numBtn.textContent);
    }
    if(selectedCards.has(i)){
      if(colorBtn) c.colors=[colorBtn.textContent];
      if(numBtn) c.numbers=[numBtn.textContent];
    }
  });

  const li=document.createElement("li");
  li.className="list-group-item";
  li.textContent=`${colorBtn?"è‰²":"æ•°å­—"}:${colorBtn?.textContent||numBtn.textContent}`;
  hintHistory.prepend(li);

  document.querySelectorAll(".btn-toggle.active").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".card-item.selected").forEach(c=>c.classList.remove("selected"));
  selectedCards.clear();

  renderCandidates();
};

undoBtn.onclick=()=>{
  if(!history.length) return;
  handCandidates=history.pop();
  hintHistory.firstChild?.remove();
  renderCandidates();
};
</script>
</body>
</html>
